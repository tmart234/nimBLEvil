name: Build Custom NimBLE Firmware

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-nrf52-fuzzer:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Setup Build Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y git make gcc-arm-none-eabi python3 python3-pip golang-go
        # Install Mynewt Newt from source
        wget https://github.com/apache/mynewt-newt/archive/refs/tags/mynewt_1_13_0_tag.zip
        unzip mynewt_1_13_0_tag.zip
        cd mynewt-newt-mynewt_1_13_0_tag
        ./build.sh
        sudo mv newt/newt /usr/local/bin
        newt version

    - name: Add Fuzzing Source
      run: |
        mkdir -p repos/apache-mynewt-nimble/apps/blehci/src/fuzz
        cp src/ble_fuzz.* repos/apache-mynewt-nimble/apps/blehci/src/fuzz/
        echo 'syscfg.vals.FUZZING_MODE: 1' >> repos/apache-mynewt-nimble/apps/blehci/syscfg.yml

    - name: Apply Patches
      run: |
        # Verify patch files first
        for patch in patches/*.patch; do
          echo "Checking patch: $patch"
          git apply --check --ignore-space-change $patch || :
        done
        
        # Apply patches with verbose output
        NIMBLE_VER=$(grep 'apache-mynewt-nimble' src/project.yml | awk -F: '{print $2}')
        for patch in patches/*.patch; do
          echo "Applying patch: $patch"
          git apply -v --ignore-space-change $patch || {
            echo "Failed to apply $patch"
            exit 1
          }
        done

    - name: Build Fuzzing Firmware
      run: |
        newt target create nrf52_fuzzer
        newt target set nrf52_fuzzer app=@apache-mynewt-nimble/apps/blehci
        newt target set nrf52_fuzzer bsp=@apache-mynewt-core/hw/bsp/nrf52dk
        newt target set nrf52_fuzzer build_profile=optimized
        newt build nrf52_fuzzer
        newt create-image nrf52_fuzzer 1.0.0
        newt obj copy nrf52_fuzzer firmware.elf

    - name: Upload Firmware Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ble-fuzzer-firmware
        path: |
          firmware.elf
          repos/apache-mynewt-nimble/bin/nrf52_fuzzer/*

    - name: Verify Patches
      run: |
        arm-none-eabi-objdump -t firmware.elf | grep -q 'g_phy_raw_tx_mode'
        arm-none-eabi-objdump -t firmware.elf | grep -q 'ble_fuzz_init'